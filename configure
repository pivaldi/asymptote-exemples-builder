#!/bin/bash

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
PARENT_DIR=$( cd -- "${SCRIPT_DIR}/.." &> /dev/null && pwd )

BIN_DIR="${SCRIPT_DIR}/bin"

. "${BIN_DIR}/confirm.rc" || exit 1

export ROOT_PROJECT_DIR="$SCRIPT_DIR"
CONFIG_FILE="${BIN_DIR}/config.rc"

read_path() {
  read -e -p "" -i "$1" $2
}

must_installed() {
  type $1 &> /dev/null || {
    echo "The command '$1' is not found. Please, install it : $2"
    exit 1
  }
}


must_installed pygmentize "https://pygments.org/download/"
must_installed asy "https://asymptote.sourceforge.io/"
must_installed make "apt install make # For Debian like OS"
must_installed convert "apt install imagemagick # For Debian like OS"

[ -e "$CONFIG_FILE" ] && {
  echo "The file $CONFIG_FILE already exists…"
  echo -n "Do you want to overwrite it ? "
  confirm || {
    echo "Ok, configuration is aborted…"
    exit 1
  }
}

echo "The Asymptote examples available in the repository https://github.com/pivaldi/asymptote-exemples.git must be in your computer…"
echo "Enter the absolute directory path where the Asymptote examples live (C-c to interrupt the configuration) : "

SOURCE_DIR=

[ -e "${PARENT_DIR}/asymptote-exemples" ] && SOURCE_DIR="${PARENT_DIR}/asymptote-exemples" || SOURCE_DIR="${PARENT_DIR}"

read_path "$SOURCE_DIR" SOURCE_DIR

[ -e "$SOURCE_DIR" ] || {
  echo "$SOURCE_DIR does not exists. Configuration is aborted…"
  exit 1
}

# Remove slash from the end of SOURCE_DIR
case $SOURCE_DIR in *[!/]*/) SOURCE_DIR=${SOURCE_DIR%"${SOURCE_DIR##*[!/]}"};; esac

ASY_CMD=$(which asy)
echo -n "Enter the absolute path to the Asymptote command : "
read_path "$ASY_CMD" ASY_CMD

XSLTPROC_CMD=$(which xsltproc)
echo -n "Enter the absolute path to the xsltproc command : "
read_path "$XSLTPROC_CMD" XSLTPROC_CMD

CONVERT_CMD=$(which convert)
echo -n "Enter the absolute path to the convert command : "
read_path "$CONVERT_CMD" CONVERT_CMD

PYGMENTYZE_CMD=$(which pygmentize)
echo -n "Enter the absolute path to the pygmentize command : "
read_path "$PYGMENTYZE_CMD" PYGMENTYZE_CMD

$BIN_DIR/mkdirs.sh || exit 1

echo "SOURCE_DIR='$SOURCE_DIR'" > "$CONFIG_FILE"
echo "ROOT_PROJECT_DIR='$ROOT_PROJECT_DIR'" >> "$CONFIG_FILE"
echo "ASY_CMD='$ASY_CMD'" >> "$CONFIG_FILE"
echo "XSLTPROC_CMD='$XSLTPROC_CMD'" >> "$CONFIG_FILE"
echo "CONVERT_CMD='$CONVERT_CMD'" >> "$CONFIG_FILE"
echo "PYGMENTYZE_CMD='$PYGMENTYZE_CMD'" >> "$CONFIG_FILE"

echo -e "\nDone !"
